# mcp_srv_mgr ä¸ Unla Gateway é›†æˆæµ‹è¯•æŒ‡å—

## ğŸ¯ æµ‹è¯•ç›®æ ‡

æœ¬æµ‹è¯•å¥—ä»¶éªŒè¯ `mcp_srv_mgr`ï¼ˆLinux æœåŠ¡ç®¡ç†ç³»ç»Ÿï¼‰ä¸ Unla MCP Gateway çš„å®Œæ•´é›†æˆï¼Œç¡®ä¿ï¼š

1. **4ç§åè®®**å…¨éƒ¨æ­£å¸¸å·¥ä½œï¼šHTTP APIã€MCP stdioã€MCP HTTP SSEã€MCP Streamable
2. **æ•°æ®åº“æŒä¹…åŒ–**åŠŸèƒ½æ­£å¸¸ï¼šMySQL ä¼šè¯ç®¡ç† + Redis ç¼“å­˜
3. **ç½‘å…³ä»£ç†**åŠŸèƒ½å®Œæ•´ï¼šAI æ¨¡å‹å¯é€šè¿‡ç»Ÿä¸€æ¥å£è®¿é—®æœåŠ¡ç®¡ç†åŠŸèƒ½
4. **ç”Ÿäº§å°±ç»ª**ï¼šæ€§èƒ½ã€å®‰å…¨ã€é”™è¯¯å¤„ç†ç­‰æ–¹é¢è¾¾åˆ°ç”Ÿäº§æ ‡å‡†

## ğŸš€ å¿«é€Ÿå¼€å§‹ï¼ˆ30ç§’è¿è¡Œï¼‰

```bash
# 1. æ„å»ºæœåŠ¡å™¨ï¼ˆå¦‚æœè¿˜æ²¡æ„å»ºï¼‰
go build -o mcp-server cmd/server/main.go

# 2. å¯åŠ¨æ•°æ®åº“ï¼ˆåå°è¿è¡Œï¼‰
docker-compose -f test_mcp_gateway/docker-compose.yml up -d

# 3. è¿è¡Œå…¨å¥—æµ‹è¯•ï¼ˆè‡ªåŠ¨åŒ–ï¼‰
./test_mcp_gateway/run_all_tests.sh
```

**é¢„æœŸç»“æœ**ï¼šæ‰€æœ‰æµ‹è¯•é€šè¿‡ï¼Œæ˜¾ç¤º `ğŸ‰ æ‰€æœ‰æµ‹è¯•é€šè¿‡ï¼`

## ğŸ“‹ æµ‹è¯•æ¸…å•

### âœ… ç¬¬ä¸€é˜¶æ®µï¼šåŸºç¡€ç¯å¢ƒæµ‹è¯•
- [ ] MySQL æ•°æ®åº“è¿æ¥ï¼ˆlocalhost:3311ï¼‰
- [ ] Redis ç¼“å­˜è¿æ¥ï¼ˆlocalhost:6379ï¼‰
- [ ] æ•°æ®è¡¨åˆ›å»ºå’Œ CRUD æ“ä½œ
- [ ] JSON æ•°æ®å¤„ç†å’Œäº‹åŠ¡æ”¯æŒ

### âœ… ç¬¬äºŒé˜¶æ®µï¼šç›´æ¥åè®®æµ‹è¯•
- [ ] HTTP REST APIï¼ˆç«¯å£ 8080ï¼‰
- [ ] MCP stdio åè®®ï¼ˆæ ‡å‡†è¾“å…¥è¾“å‡ºï¼‰
- [ ] MCP HTTP SSEï¼ˆç«¯å£ 8082ï¼‰
- [ ] MCP Streamableï¼ˆç«¯å£ 8083ï¼‰

### âœ… ç¬¬ä¸‰é˜¶æ®µï¼šç½‘å…³é›†æˆæµ‹è¯•
- [ ] Unla Gateway ä»£ç† HTTP API
- [ ] Unla Gateway ä»£ç† MCP stdio
- [ ] Unla Gateway ä»£ç† MCP HTTP SSE
- [ ] Unla Gateway ä»£ç† MCP Streamable

## ğŸ”§ è¯¦ç»†æµ‹è¯•è¯´æ˜

### 1. æ•°æ®åº“é›†æˆæµ‹è¯• (`test_mysql_integration.sh`)

**æµ‹è¯•å†…å®¹**ï¼š
- MySQL è¿æ¥éªŒè¯ï¼ˆ127.0.0.1:3311ï¼Œç”¨æˆ·ï¼šrootï¼Œå¯†ç ï¼šnov24feb11ï¼‰
- Redis è¿æ¥éªŒè¯ï¼ˆ127.0.0.1:6379ï¼Œæ— å¯†ç ï¼‰
- åˆ›å»º `unla_sessions`ã€`unla_configurations`ã€`unla_metrics` è¡¨
- æ’å…¥ã€æŸ¥è¯¢ã€æ›´æ–°ã€åˆ é™¤æ“ä½œ
- JSON å­—æ®µæ“ä½œå’Œå¤æ‚æŸ¥è¯¢
- äº‹åŠ¡å¤„ç†å’Œæ€§èƒ½æµ‹è¯•

**é‡è¦æŒ‡æ ‡**ï¼š
- æ‰€æœ‰ CRUD æ“ä½œ < 100ms
- æ”¯æŒå¹¶å‘è¿æ¥ï¼ˆæµ‹è¯• 5 ä¸ªå¹¶å‘è¿æ¥ï¼‰
- JSON æŸ¥è¯¢å’Œæ›´æ–°åŠŸèƒ½æ­£å¸¸

### 2. HTTP API é›†æˆæµ‹è¯• (`test_http_api.sh`)

**æµ‹è¯•å†…å®¹**ï¼š
- å¥åº·æ£€æŸ¥ï¼š`GET /health`
- æœåŠ¡åˆ—è¡¨ï¼š`GET /services`
- æœåŠ¡çŠ¶æ€ï¼š`GET /services/{name}/status`
- æœåŠ¡æ“ä½œï¼š`POST /services/{name}/{action}`ï¼ˆstart/stop/restart/enable/disableï¼‰
- Docker æ“ä½œï¼š`GET /docker/{name}/logs`
- ç½‘å…³ä»£ç†ï¼šé€šè¿‡ Unla Gateway è®¿é—®æ‰€æœ‰ä¸Šè¿°ç«¯ç‚¹

**æµ‹è¯•åœºæ™¯**ï¼š
```bash
# ç›´æ¥è®¿é—® mcp_srv_mgr
curl http://127.0.0.1:8080/services

# é€šè¿‡ Unla Gateway è®¿é—®ï¼ˆMCP åè®®è½¬æ¢ï¼‰
curl -X POST http://127.0.0.1:8081/mcp \
  -H "Content-Type: application/json" \
  -d '{"jsonrpc":"2.0","id":1,"method":"tools/call","params":{"name":"list_services"}}'
```

### 3. MCP stdio åè®®æµ‹è¯• (`test_mcp_stdio.sh`)

**æµ‹è¯•å†…å®¹**ï¼š
- MCP åè®®åˆå§‹åŒ–å’Œèƒ½åŠ›åå•†
- å·¥å…·åˆ—è¡¨æŸ¥è¯¢ï¼š`tools/list`
- å·¥å…·è°ƒç”¨ï¼š`tools/call`ï¼ˆæ‰€æœ‰æœåŠ¡ç®¡ç†å·¥å…·ï¼‰
- æç¤ºæ¨¡æ¿ï¼š`prompts/list`ã€`prompts/get`
- ç½‘å…³ stdio ä»£ç†åŠŸèƒ½

**MCP å·¥å…·éªŒè¯**ï¼š
- `list_services`ï¼šåˆ—å‡ºç³»ç»Ÿæ‰€æœ‰æœåŠ¡
- `get_service_status`ï¼šè·å–ç‰¹å®šæœåŠ¡çŠ¶æ€  
- `start_service`ã€`stop_service`ã€`restart_service`ï¼šæœåŠ¡æ§åˆ¶
- `enable_service`ã€`disable_service`ï¼šå¼€æœºå¯åŠ¨æ§åˆ¶
- `get_docker_logs`ï¼šDocker å®¹å™¨æ—¥å¿—

### 4. MCP HTTP SSE æµ‹è¯• (`test_mcp_http_sse.sh`)

**æµ‹è¯•å†…å®¹**ï¼š
- HTTP POST æ–¹å¼çš„ MCP é€šä¿¡ï¼ˆç«¯å£ 8082ï¼‰
- æœåŠ¡å™¨å‘é€äº‹ä»¶ï¼ˆSSEï¼‰æµå¼å“åº”
- é•¿è¿æ¥å’Œå®æ—¶é€šä¿¡
- ç½‘å…³ HTTP SSE ä»£ç†

**å…³é”®ç‰¹æ€§**ï¼š
- æ”¯æŒå®æ—¶æ•°æ®æ¨é€
- é€‚åˆéœ€è¦æŒç»­ç›‘æ§çš„åœºæ™¯ï¼ˆå¦‚æ—¥å¿—æµã€çŠ¶æ€å˜æ›´ï¼‰
- ç½‘å…³é€æ˜ä»£ç† SSE æµ

### 5. MCP Streamable HTTP æµ‹è¯• (`test_mcp_streamable.sh`)

**æµ‹è¯•å†…å®¹**ï¼š
- åŒå‘æµå¼é€šä¿¡ï¼ˆç«¯å£ 8083ï¼‰
- WebSocket ç±»ä¼¼çš„æŒä¹…è¿æ¥
- å¤§æ•°æ®é‡ä¼ è¾“å’Œé•¿æ—¶é—´æ“ä½œ
- ç½‘å…³æµå¼ä»£ç†åŠŸèƒ½

**é«˜çº§ç‰¹æ€§**ï¼š
- æ”¯æŒå®¢æˆ·ç«¯å‘æœåŠ¡å™¨çš„æµå¼æ•°æ®æ¨é€
- é€‚åˆå¤§æ–‡ä»¶ä¼ è¾“ã€æ‰¹é‡æ“ä½œ
- ç½‘å…³ç»´æŒé•¿è¿æ¥å’ŒçŠ¶æ€

## ğŸ“Š æµ‹è¯•æŠ¥å‘Šè§£è¯»

### æˆåŠŸç¤ºä¾‹
```
ğŸ§ª Testing HTTP API Integration with Unla Gateway
==================================================
âœ… Health Check: PASSED
âœ… List Services: PASSED  
âœ… Get Service Status: PASSED
âœ… Service Action: PASSED

ğŸ“Š Direct API Test Results:
   Passed: 4
   Failed: 0

ğŸ‰ All tests passed!
```

### å¤±è´¥æ’æŸ¥
```
âŒ MySQL Connection: FAILED
Error: Expected status 200, got 000
Response: curl: (7) Failed to connect to 127.0.0.1:3311
```

**è§£å†³æ–¹æ¡ˆ**ï¼š
1. æ£€æŸ¥ Docker å®¹å™¨ï¼š`docker-compose -f test_mcp_gateway/docker-compose.yml ps`
2. å¯åŠ¨æ•°æ®åº“ï¼š`docker-compose -f test_mcp_gateway/docker-compose.yml up -d mysql`
3. ç­‰å¾…å¯åŠ¨å®Œæˆï¼š`sleep 10`

## ğŸ›ï¸ é…ç½®æ–‡ä»¶è¯´æ˜

### `unla-config.yaml` - æ ¸å¿ƒé…ç½®

**æ•°æ®åº“é…ç½®**ï¼š
```yaml
database:
  type: mysql
  host: 127.0.0.1
  port: 3311
  username: root
  password: nov24feb11
  database: unla_gateway
```

**4 ç§æœåŠ¡é›†æˆ**ï¼š
```yaml
integrations:
  - name: mcp_srv_mgr_http          # HTTP API è½¬ MCP å·¥å…·
  - name: mcp_srv_mgr_stdio         # MCP stdio ä»£ç†
  - name: mcp_srv_mgr_http_sse      # MCP HTTP SSE ä»£ç†
  - name: mcp_srv_mgr_streamable    # MCP Streamable ä»£ç†
```

**å·¥å…·æ˜ å°„**ï¼ˆHTTP API â†’ MCP å·¥å…·ï¼‰ï¼š
```yaml
tools:
  - name: list_services
    method: GET
    path: "/services"
  - name: start_service  
    method: POST
    path: "/services/{name}/start"
```

## ğŸš¨ å¸¸è§é—®é¢˜è§£å†³

### é—®é¢˜ 1ï¼šç«¯å£å†²çª
```bash
# é”™è¯¯ï¼šbind: address already in use
# è§£å†³ï¼šæ£€æŸ¥ç«¯å£å ç”¨
lsof -i :8080 :8081 :8082 :8083 :3311 :6379
kill <PID>  # æ€æ‰å†²çªè¿›ç¨‹
```

### é—®é¢˜ 2ï¼šæ•°æ®åº“è¿æ¥è¶…æ—¶
```bash
# é”™è¯¯ï¼šconnection timeout
# è§£å†³ï¼šæ£€æŸ¥å®¹å™¨çŠ¶æ€
docker-compose -f test_mcp_gateway/docker-compose.yml logs mysql
docker-compose -f test_mcp_gateway/docker-compose.yml restart mysql
```

### é—®é¢˜ 3ï¼šç½‘å…³å¯åŠ¨å¤±è´¥
```bash
# é”™è¯¯ï¼šgateway config error  
# è§£å†³ï¼šæ£€æŸ¥é…ç½®æ–‡ä»¶
./mcp-gateway --config test_mcp_gateway/unla-config.yaml --validate
```

### é—®é¢˜ 4ï¼šå·¥å…·æ‰§è¡Œå¤±è´¥
```bash
# é”™è¯¯ï¼štool execution failed
# è§£å†³ï¼šæ£€æŸ¥æœåŠ¡æƒé™
sudo chmod +x ./mcp-server
# æ£€æŸ¥ç³»ç»ŸæœåŠ¡
systemctl status nginx  # ç¡®ä¿æœ‰æµ‹è¯•ç”¨çš„æœåŠ¡
```

## ğŸ¯ ç”Ÿäº§ç¯å¢ƒå‡†å¤‡

æµ‹è¯•å…¨éƒ¨é€šè¿‡åï¼ŒæŒ‰ä»¥ä¸‹æ­¥éª¤éƒ¨ç½²åˆ°ç”Ÿäº§ç¯å¢ƒï¼š

### 1. å®‰å…¨é…ç½®
```yaml
# unla-config.yaml ç”Ÿäº§é…ç½®
security:
  enable_auth: true
  jwt_secret: "ç”Ÿäº§ç¯å¢ƒå¼ºå¯†ç "
  admin_username: "admin"  
  admin_password: "ç”Ÿäº§ç¯å¢ƒå¼ºå¯†ç "
```

### 2. æ•°æ®åº“å®‰å…¨
```bash
# æ›´æ”¹é»˜è®¤å¯†ç 
ALTER USER 'root'@'%' IDENTIFIED BY 'ç”Ÿäº§ç¯å¢ƒå¼ºå¯†ç ';
# åˆ›å»ºä¸“ç”¨ç”¨æˆ·
CREATE USER 'unla'@'%' IDENTIFIED BY 'ç”Ÿäº§ç¯å¢ƒå¯†ç ';
GRANT ALL PRIVILEGES ON unla_gateway.* TO 'unla'@'%';
```

### 3. ç½‘ç»œé…ç½®
```yaml
# é™åˆ¶ç½‘ç»œè®¿é—®
server:
  host: "å†…ç½‘IP"  # ä¸è¦ä½¿ç”¨ 0.0.0.0
  port: 8081
  enable_cors: false  # ç”Ÿäº§ç¯å¢ƒå…³é—­ CORS
```

### 4. ç›‘æ§é…ç½®
```yaml
monitoring:
  enable_metrics: true
  metrics_port: 9090
  health_check_interval: 30s
logging:
  level: info
  output: "/var/log/unla-gateway.log"
```

## ğŸ‰ æµ‹è¯•æˆåŠŸåçš„ä½¿ç”¨

### AI æ¨¡å‹è¿æ¥
```python
# Python ç¤ºä¾‹
import requests

# è¿æ¥ç½‘å…³
gateway_url = "http://127.0.0.1:8081/mcp"

# åˆ—å‡ºå¯ç”¨å·¥å…·
response = requests.post(gateway_url, json={
    "jsonrpc": "2.0",
    "id": 1,
    "method": "tools/list",
    "params": {}
})

# è°ƒç”¨æœåŠ¡ç®¡ç†å·¥å…·
response = requests.post(gateway_url, json={
    "jsonrpc": "2.0", 
    "id": 2,
    "method": "tools/call",
    "params": {
        "name": "get_service_status",
        "arguments": {"service_name": "nginx"}
    }
})
```

### Claude Code é›†æˆ
```javascript
// åœ¨ Claude Code ä¸­ä½¿ç”¨
const mcp_client = new MCPClient("http://127.0.0.1:8081");

// è·å–æœåŠ¡çŠ¶æ€
const status = await mcp_client.call_tool("get_service_status", {
    service_name: "apache2"
});

// é‡å¯æœåŠ¡
const result = await mcp_client.call_tool("restart_service", {
    service_name: "apache2"  
});
```

---

**ğŸ¯ æ€»ç»“**ï¼šæœ¬æµ‹è¯•å¥—ä»¶ç¡®ä¿æ‚¨çš„ Linux æœåŠ¡ç®¡ç†ç³»ç»Ÿèƒ½å¤Ÿæ— ç¼é›†æˆåˆ° AI å·¥ä½œæµç¨‹ä¸­ï¼Œé€šè¿‡ Unla Gateway ä¸º AI æ¨¡å‹æä¾›å¼ºå¤§çš„ç³»ç»Ÿç®¡ç†èƒ½åŠ›ï¼