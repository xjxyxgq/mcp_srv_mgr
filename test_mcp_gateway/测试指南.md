# mcp_srv_mgr 与 Unla Gateway 集成测试指南

## 🎯 测试目标

本测试套件验证 `mcp_srv_mgr`（Linux 服务管理系统）与 Unla MCP Gateway 的完整集成，确保：

1. **4种协议**全部正常工作：HTTP API、MCP stdio、MCP HTTP SSE、MCP Streamable
2. **数据库持久化**功能正常：MySQL 会话管理 + Redis 缓存
3. **网关代理**功能完整：AI 模型可通过统一接口访问服务管理功能
4. **生产就绪**：性能、安全、错误处理等方面达到生产标准

## 🚀 快速开始（30秒运行）

```bash
# 1. 构建服务器（如果还没构建）
go build -o mcp-server cmd/server/main.go

# 2. 启动数据库（后台运行）
docker-compose -f test_mcp_gateway/docker-compose.yml up -d

# 3. 运行全套测试（自动化）
./test_mcp_gateway/run_all_tests.sh
```

**预期结果**：所有测试通过，显示 `🎉 所有测试通过！`

## 📋 测试清单

### ✅ 第一阶段：基础环境测试
- [ ] MySQL 数据库连接（localhost:3311）
- [ ] Redis 缓存连接（localhost:6379）
- [ ] 数据表创建和 CRUD 操作
- [ ] JSON 数据处理和事务支持

### ✅ 第二阶段：直接协议测试
- [ ] HTTP REST API（端口 8080）
- [ ] MCP stdio 协议（标准输入输出）
- [ ] MCP HTTP SSE（端口 8082）
- [ ] MCP Streamable（端口 8083）

### ✅ 第三阶段：网关集成测试
- [ ] Unla Gateway 代理 HTTP API
- [ ] Unla Gateway 代理 MCP stdio
- [ ] Unla Gateway 代理 MCP HTTP SSE
- [ ] Unla Gateway 代理 MCP Streamable

## 🔧 详细测试说明

### 1. 数据库集成测试 (`test_mysql_integration.sh`)

**测试内容**：
- MySQL 连接验证（127.0.0.1:3311，用户：root，密码：nov24feb11）
- Redis 连接验证（127.0.0.1:6379，无密码）
- 创建 `unla_sessions`、`unla_configurations`、`unla_metrics` 表
- 插入、查询、更新、删除操作
- JSON 字段操作和复杂查询
- 事务处理和性能测试

**重要指标**：
- 所有 CRUD 操作 < 100ms
- 支持并发连接（测试 5 个并发连接）
- JSON 查询和更新功能正常

### 2. HTTP API 集成测试 (`test_http_api.sh`)

**测试内容**：
- 健康检查：`GET /health`
- 服务列表：`GET /services`
- 服务状态：`GET /services/{name}/status`
- 服务操作：`POST /services/{name}/{action}`（start/stop/restart/enable/disable）
- Docker 操作：`GET /docker/{name}/logs`
- 网关代理：通过 Unla Gateway 访问所有上述端点

**测试场景**：
```bash
# 直接访问 mcp_srv_mgr
curl http://127.0.0.1:8080/services

# 通过 Unla Gateway 访问（MCP 协议转换）
curl -X POST http://127.0.0.1:8081/mcp \
  -H "Content-Type: application/json" \
  -d '{"jsonrpc":"2.0","id":1,"method":"tools/call","params":{"name":"list_services"}}'
```

### 3. MCP stdio 协议测试 (`test_mcp_stdio.sh`)

**测试内容**：
- MCP 协议初始化和能力协商
- 工具列表查询：`tools/list`
- 工具调用：`tools/call`（所有服务管理工具）
- 提示模板：`prompts/list`、`prompts/get`
- 网关 stdio 代理功能

**MCP 工具验证**：
- `list_services`：列出系统所有服务
- `get_service_status`：获取特定服务状态  
- `start_service`、`stop_service`、`restart_service`：服务控制
- `enable_service`、`disable_service`：开机启动控制
- `get_docker_logs`：Docker 容器日志

### 4. MCP HTTP SSE 测试 (`test_mcp_http_sse.sh`)

**测试内容**：
- HTTP POST 方式的 MCP 通信（端口 8082）
- 服务器发送事件（SSE）流式响应
- 长连接和实时通信
- 网关 HTTP SSE 代理

**关键特性**：
- 支持实时数据推送
- 适合需要持续监控的场景（如日志流、状态变更）
- 网关透明代理 SSE 流

### 5. MCP Streamable HTTP 测试 (`test_mcp_streamable.sh`)

**测试内容**：
- 双向流式通信（端口 8083）
- WebSocket 类似的持久连接
- 大数据量传输和长时间操作
- 网关流式代理功能

**高级特性**：
- 支持客户端向服务器的流式数据推送
- 适合大文件传输、批量操作
- 网关维持长连接和状态

## 📊 测试报告解读

### 成功示例
```
🧪 Testing HTTP API Integration with Unla Gateway
==================================================
✅ Health Check: PASSED
✅ List Services: PASSED  
✅ Get Service Status: PASSED
✅ Service Action: PASSED

📊 Direct API Test Results:
   Passed: 4
   Failed: 0

🎉 All tests passed!
```

### 失败排查
```
❌ MySQL Connection: FAILED
Error: Expected status 200, got 000
Response: curl: (7) Failed to connect to 127.0.0.1:3311
```

**解决方案**：
1. 检查 Docker 容器：`docker-compose -f test_mcp_gateway/docker-compose.yml ps`
2. 启动数据库：`docker-compose -f test_mcp_gateway/docker-compose.yml up -d mysql`
3. 等待启动完成：`sleep 10`

## 🎛️ 配置文件说明

### `unla-config.yaml` - 核心配置

**数据库配置**：
```yaml
database:
  type: mysql
  host: 127.0.0.1
  port: 3311
  username: root
  password: nov24feb11
  database: unla_gateway
```

**4 种服务集成**：
```yaml
integrations:
  - name: mcp_srv_mgr_http          # HTTP API 转 MCP 工具
  - name: mcp_srv_mgr_stdio         # MCP stdio 代理
  - name: mcp_srv_mgr_http_sse      # MCP HTTP SSE 代理
  - name: mcp_srv_mgr_streamable    # MCP Streamable 代理
```

**工具映射**（HTTP API → MCP 工具）：
```yaml
tools:
  - name: list_services
    method: GET
    path: "/services"
  - name: start_service  
    method: POST
    path: "/services/{name}/start"
```

## 🚨 常见问题解决

### 问题 1：端口冲突
```bash
# 错误：bind: address already in use
# 解决：检查端口占用
lsof -i :8080 :8081 :8082 :8083 :3311 :6379
kill <PID>  # 杀掉冲突进程
```

### 问题 2：数据库连接超时
```bash
# 错误：connection timeout
# 解决：检查容器状态
docker-compose -f test_mcp_gateway/docker-compose.yml logs mysql
docker-compose -f test_mcp_gateway/docker-compose.yml restart mysql
```

### 问题 3：网关启动失败
```bash
# 错误：gateway config error  
# 解决：检查配置文件
./mcp-gateway --config test_mcp_gateway/unla-config.yaml --validate
```

### 问题 4：工具执行失败
```bash
# 错误：tool execution failed
# 解决：检查服务权限
sudo chmod +x ./mcp-server
# 检查系统服务
systemctl status nginx  # 确保有测试用的服务
```

## 🎯 生产环境准备

测试全部通过后，按以下步骤部署到生产环境：

### 1. 安全配置
```yaml
# unla-config.yaml 生产配置
security:
  enable_auth: true
  jwt_secret: "生产环境强密码"
  admin_username: "admin"  
  admin_password: "生产环境强密码"
```

### 2. 数据库安全
```bash
# 更改默认密码
ALTER USER 'root'@'%' IDENTIFIED BY '生产环境强密码';
# 创建专用用户
CREATE USER 'unla'@'%' IDENTIFIED BY '生产环境密码';
GRANT ALL PRIVILEGES ON unla_gateway.* TO 'unla'@'%';
```

### 3. 网络配置
```yaml
# 限制网络访问
server:
  host: "内网IP"  # 不要使用 0.0.0.0
  port: 8081
  enable_cors: false  # 生产环境关闭 CORS
```

### 4. 监控配置
```yaml
monitoring:
  enable_metrics: true
  metrics_port: 9090
  health_check_interval: 30s
logging:
  level: info
  output: "/var/log/unla-gateway.log"
```

## 🎉 测试成功后的使用

### AI 模型连接
```python
# Python 示例
import requests

# 连接网关
gateway_url = "http://127.0.0.1:8081/mcp"

# 列出可用工具
response = requests.post(gateway_url, json={
    "jsonrpc": "2.0",
    "id": 1,
    "method": "tools/list",
    "params": {}
})

# 调用服务管理工具
response = requests.post(gateway_url, json={
    "jsonrpc": "2.0", 
    "id": 2,
    "method": "tools/call",
    "params": {
        "name": "get_service_status",
        "arguments": {"service_name": "nginx"}
    }
})
```

### Claude Code 集成
```javascript
// 在 Claude Code 中使用
const mcp_client = new MCPClient("http://127.0.0.1:8081");

// 获取服务状态
const status = await mcp_client.call_tool("get_service_status", {
    service_name: "apache2"
});

// 重启服务
const result = await mcp_client.call_tool("restart_service", {
    service_name: "apache2"  
});
```

---

**🎯 总结**：本测试套件确保您的 Linux 服务管理系统能够无缝集成到 AI 工作流程中，通过 Unla Gateway 为 AI 模型提供强大的系统管理能力！