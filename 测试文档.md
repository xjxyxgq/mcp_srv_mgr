# 🧪 Linux服务管理器 - 测试文档

## 📋 测试概览

本项目提供全面的测试覆盖，包括单元测试、集成测试、性能测试和安全测试。

### 📊 测试统计
- **测试文件数量**: 8个
- **测试类型**: 单元测试、集成测试、性能测试
- **覆盖的组件**: 所有核心模块
- **目标覆盖率**: >80%

## 🗂️ 测试文件结构

```
测试文件/
├── utils_test.go          # 工具函数测试
├── types_test.go          # 数据结构测试
├── config_test.go         # 配置管理测试
├── systemd_test.go        # systemd管理器测试
├── sysv_test.go          # SysV管理器测试
├── docker_test.go        # Docker管理器测试
├── server_test.go        # HTTP服务器测试
├── mcp_server_test.go    # MCP服务器测试
└── integration_test.go   # 集成测试
```

## 🔧 测试工具和脚本

### 主要测试脚本
- **`test.sh`** - 主测试脚本，支持多种测试模式
- **`Makefile`** - 简化的测试命令
- **Docker配置** - 容器化测试环境

### CI/CD配置
- **GitHub Actions** - 自动化测试流水线
- **多平台构建** - Linux、macOS、Windows
- **安全扫描** - Gosec、Trivy

## 🚀 快速开始

### 运行单元测试
```bash
# 使用测试脚本
./test.sh -u -v

# 使用Makefile
make test

# 直接使用go test
go test -v ./...
```

### 运行所有测试
```bash
# 包括集成测试和性能测试
./test.sh -a -v

# 使用Makefile
make test-all
```

### 生成覆盖率报告
```bash
# 生成HTML覆盖率报告
./test.sh -c

# 查看覆盖率
make test-coverage
```

## 📝 测试分类详解

### 1. 单元测试

#### 工具函数测试 (`utils_test.go`)
- ✅ `parseInt()` 函数测试
- ✅ `getCurrentTimestamp()` 函数测试
- ✅ 边界值和错误情况测试

#### 数据结构测试 (`types_test.go`)
- ✅ JSON序列化/反序列化测试
- ✅ 数据验证测试
- ✅ 常量值验证测试

#### 配置管理测试 (`config_test.go`)
- ✅ 默认配置加载测试
- ✅ 文件配置加载测试
- ✅ 环境变量覆盖测试
- ✅ 错误处理测试

### 2. 服务管理器测试

#### systemd管理器测试 (`systemd_test.go`)
- ✅ 服务状态查询测试
- ✅ 服务列表获取测试
- ✅ 时间字段解析测试
- ✅ 错误处理测试
- ⚠️ 服务操作测试（需要权限）

#### SysV管理器测试 (`sysv_test.go`)
- ✅ 服务脚本检测测试
- ✅ PID提取测试
- ✅ 运行时间解析测试
- ✅ 服务描述提取测试
- ✅ Mock服务测试

#### Docker管理器测试 (`docker_test.go`)
- ✅ JSON解析测试
- ✅ 容器列表测试
- ✅ 容器状态测试
- ✅ 日志和统计测试
- ⚠️ 容器操作测试（需要Docker）

### 3. 服务器测试

#### HTTP服务器测试 (`server_test.go`)
- ✅ 路由测试
- ✅ API端点测试
- ✅ 错误处理测试
- ✅ 并发请求测试
- ✅ Mock服务管理器测试

#### MCP服务器测试 (`mcp_server_test.go`)
- ✅ 协议初始化测试
- ✅ 工具列表测试
- ✅ 工具调用测试
- ✅ 提示词测试
- ✅ 错误响应测试

### 4. 集成测试 (`integration_test.go`)

#### HTTP工作流程测试
- ✅ 完整API调用流程
- ✅ 健康检查测试
- ✅ 服务操作工作流
- ✅ 并发请求测试
- ✅ 错误恢复测试

#### MCP协议测试
- ✅ 协议握手测试
- ✅ 工具发现测试
- ✅ 工具执行测试

#### 真实系统测试
- ⚠️ 实际systemd服务测试（需要权限）
- ⚠️ 实际Docker容器测试（需要Docker）

## 🎯 测试运行指南

### 测试环境要求

#### 基本要求
- Go 1.21或更高版本
- Linux操作系统（推荐）

#### 可选要求
- **systemd** - 用于systemd服务测试
- **Docker** - 用于Docker容器测试
- **Root权限** - 用于某些集成测试

### 测试模式

#### 1. 快速测试模式
```bash
# 只运行快速测试，跳过长时间运行的测试
./test.sh -s
```

#### 2. 详细模式
```bash
# 显示详细的测试输出
./test.sh -v
```

#### 3. 竞态检测模式
```bash
# 启用竞态条件检测
./test.sh -r
```

#### 4. 集成测试模式
```bash
# 运行需要系统资源的测试
./test.sh -i
```

### Docker中运行测试

#### 构建测试环境
```bash
# 使用Docker Compose运行测试
docker-compose --profile test up --build

# 或使用Makefile
make docker-test
```

#### 自定义测试容器
```bash
# 构建测试镜像
docker build -f Dockerfile.test -t mcp-server-test .

# 运行测试
docker run --rm -v /var/run/docker.sock:/var/run/docker.sock mcp-server-test
```

## 📊 性能测试

### 基准测试
```bash
# 运行所有基准测试
./test.sh -b

# 运行特定基准测试
go test -bench=BenchmarkSystemdManager -benchmem
```

### 性能指标
- **HTTP端点响应时间** - 目标 <100ms
- **服务列表查询** - 目标 <500ms
- **MCP工具调用** - 目标 <200ms
- **内存使用** - 目标 <50MB

## 🔒 安全测试

### 静态分析
```bash
# 使用gosec扫描
make security-scan

# 使用golangci-lint
make lint
```

### 漏洞扫描
- **Gosec** - Go代码安全扫描
- **Trivy** - 依赖漏洞扫描
- **CodeQL** - 语义代码分析

## 📈 覆盖率报告

### 生成报告
```bash
# 生成HTML覆盖率报告
./test.sh -c

# 查看覆盖率文件
go tool cover -func=coverage.out
```

### 覆盖率目标
- **总体覆盖率**: >80%
- **核心模块**: >90%
- **工具函数**: >95%

## 🐛 测试问题排除

### 常见问题

#### 1. 权限问题
```bash
# 某些测试需要root权限
sudo ./test.sh -i
```

#### 2. Docker不可用
```bash
# 启动Docker服务
sudo systemctl start docker

# 将用户添加到docker组
sudo usermod -aG docker $USER
```

#### 3. systemd不可用
```bash
# 检查systemd状态
systemctl --version
```

### 测试环境验证
```bash
# 检查测试环境
make info

# 验证所有依赖
./test.sh --clean && ./test.sh -a
```

## 🔄 持续集成

### GitHub Actions流水线
1. **代码检查** - 格式、语法、安全
2. **单元测试** - 多Go版本测试
3. **集成测试** - 系统级测试
4. **性能测试** - 基准测试
5. **构建测试** - 多平台构建
6. **安全扫描** - 漏洞检测

### 本地CI模拟
```bash
# 模拟完整CI流程
make lint && make test-all && make build-all
```

## 📋 测试清单

### 发布前检查清单
- [ ] 所有单元测试通过
- [ ] 集成测试通过
- [ ] 性能测试满足要求
- [ ] 安全扫描无高危问题
- [ ] 代码覆盖率达标
- [ ] 文档更新完整
- [ ] 多平台构建成功

### 开发测试清单
- [ ] 新功能有相应测试
- [ ] 修复的bug有回归测试
- [ ] 测试覆盖率未降低
- [ ] 性能未明显下降
- [ ] 所有现有测试仍然通过

## 🤝 贡献测试

### 编写新测试
1. 选择合适的测试文件
2. 遵循现有测试模式
3. 包含正常和异常情况
4. 添加必要的mock和stub
5. 更新测试文档

### 测试代码规范
- 测试函数命名: `TestXxx` 或 `BenchmarkXxx`
- 使用table-driven tests处理多种情况
- 适当使用subtests组织测试
- 包含必要的清理代码
- 提供有意义的错误消息

---

**通过完善的测试确保代码质量，让AI成为可靠的Linux服务管理助手！** 🚀